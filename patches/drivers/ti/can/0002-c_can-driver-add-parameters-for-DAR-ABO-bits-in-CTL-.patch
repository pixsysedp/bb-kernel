From 822b53d26e0f5b9e612ce387e5348b775bdb21d5 Mon Sep 17 00:00:00 2001
From: Antonio Galea <antonio.galea@gmail.com>
Date: Thu, 31 Oct 2024 16:47:23 +0100
Subject: [PATCH] c_can driver: add parameters for DAR, ABO bits in CTL
 register

---
 drivers/net/can/c_can/c_can_main.c | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

diff --git a/drivers/net/can/c_can/c_can_main.c b/drivers/net/can/c_can/c_can_main.c
index 637486e1657b..5e3beec967cf 100644
--- a/drivers/net/can/c_can/c_can_main.c
+++ b/drivers/net/can/c_can/c_can_main.c
@@ -27,6 +27,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/moduleparam.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
@@ -53,6 +54,7 @@
 
 /* control register */
 #define CONTROL_SWR		BIT(15)
+#define CONTROL_ABO		BIT(9)
 #define CONTROL_TEST		BIT(7)
 #define CONTROL_CCE		BIT(6)
 #define CONTROL_DISABLE_AR	BIT(5)
@@ -170,6 +172,14 @@
 /* Wait for ~1 sec for INIT bit */
 #define INIT_WAIT_MS		1000
 
+static int disable_automatic_retransmission = 0;
+module_param(disable_automatic_retransmission, int, 0);
+MODULE_PARM_DESC(disable_automatic_retransmission, "Disable automatic retransmission of frames on error (default 0)");
+
+static int auto_bus_on = 0;
+module_param(auto_bus_on, int, 0);
+MODULE_PARM_DESC(auto_bus_on, "Auto-Bus-On after a timeout (default 0)");
+
 /* c_can lec values */
 enum c_can_lec_type {
 	LEC_NO_ERROR = 0,
@@ -607,8 +617,11 @@ static int c_can_chip_config(struct net_device *dev)
 	if (err)
 		return err;
 
-	/* enable automatic retransmission */
-	priv->write_reg(priv, C_CAN_CTRL_REG, CONTROL_ENABLE_AR);
+	unsigned int val = 0;
+	if (disable_automatic_retransmission) val |= CONTROL_DISABLE_AR;
+	if (auto_bus_on) val |= CONTROL_ABO;
+	priv->write_reg(priv, C_CAN_CTRL_REG, val);
+
 
 	if ((priv->can.ctrlmode & CAN_CTRLMODE_LISTENONLY) &&
 	    (priv->can.ctrlmode & CAN_CTRLMODE_LOOPBACK)) {
-- 
2.39.5

