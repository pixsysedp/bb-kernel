From 833c3c105162abd4ef6b4d732e73caa2009bfba2 Mon Sep 17 00:00:00 2001
From: Antonio Galea <antonio.galea@gmail.com>
Date: Wed, 30 Oct 2024 11:33:39 +0100
Subject: [PATCH] c_can driver: add parameters for DAR, ABO bits in CTL
 register


diff --git a/drivers/net/can/c_can/c_can.c b/drivers/net/can/c_can/c_can.c
index 2278c5fff5c6..22d9d400c150 100644
--- a/drivers/net/can/c_can/c_can.c
+++ b/drivers/net/can/c_can/c_can.c
@@ -27,6 +27,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/moduleparam.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
@@ -53,6 +54,7 @@
 
 /* control register */
 #define CONTROL_SWR		BIT(15)
+#define CONTROL_ABO		BIT(9)
 #define CONTROL_TEST		BIT(7)
 #define CONTROL_CCE		BIT(6)
 #define CONTROL_DISABLE_AR	BIT(5)
@@ -176,6 +178,14 @@
 /* napi related */
 #define C_CAN_NAPI_WEIGHT	C_CAN_MSG_OBJ_RX_NUM
 
+static int disable_automatic_retransmission = 1;
+module_param(disable_automatic_retransmission, int, 0);
+MODULE_PARM_DESC(disable_automatic_retransmission, "Disable automatic retransmission of frames on error");
+
+static int auto_bus_on = 1;
+module_param(auto_bus_on, int, 0);
+MODULE_PARM_DESC(auto_bus_on, "Auto-Bus-On after a timeout");
+
 /* c_can lec values */
 enum c_can_lec_type {
 	LEC_NO_ERROR = 0,
@@ -596,8 +606,10 @@ static int c_can_chip_config(struct net_device *dev)
 	if (err)
 		return err;
 
-	/* enable automatic retransmission */
-	priv->write_reg(priv, C_CAN_CTRL_REG, CONTROL_ENABLE_AR);
+	unsigned int val = 0;
+	if (disable_automatic_retransmission) val |= CONTROL_DISABLE_AR;
+	if (auto_bus_on) val |= CONTROL_ABO;
+	priv->write_reg(priv, C_CAN_CTRL_REG, val);
 
 	if ((priv->can.ctrlmode & CAN_CTRLMODE_LISTENONLY) &&
 	    (priv->can.ctrlmode & CAN_CTRLMODE_LOOPBACK)) {
-- 
2.39.5

